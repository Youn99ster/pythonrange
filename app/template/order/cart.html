{% extends "base.html" %}

{% block title %}购物车 - HackShop{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
    <h2 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>我的购物车</h2>
</div>

<div id="cartContent" class="row g-3">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <input type="checkbox" id="selectAllTop" onchange="toggleSelectAll(this)">
                    <label for="selectAllTop" class="ms-1">全选</label>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="batchRemove()">
                    <i class="fas fa-trash-alt me-1"></i>删除选中
                </button>
            </div>
            <div class="card-body" id="cartItemsContainer"></div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header"><strong>订单摘要</strong></div>
            <div class="card-body">
                <p class="d-flex justify-content-between"><span>商品数量</span><span id="summaryCount">0</span></p>
                <p class="d-flex justify-content-between"><span>商品总额</span><span id="summaryTotal">¥0.00</span></p>
                <p class="d-flex justify-content-between"><span>优惠减免</span><span>-¥0.00</span></p>
                <hr>
                <p class="d-flex justify-content-between fw-bold"><span>应付总额</span><span id="summaryFinal">¥0.00</span></p>
                <button class="btn btn-primary w-100" onclick="proceedToCheckout()">
                    去结算 <i class="fas fa-arrow-right ms-1"></i>
                </button>
                <a class="btn btn-outline-secondary w-100 mt-2" href="{{ url_for('main.index') }}">继续购物</a>
            </div>
        </div>
    </div>
</div>

<div id="emptyCart" class="text-center py-5 d-none">
    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
    <h4>购物车还是空的</h4>
    <p class="text-muted">快去挑选喜欢的商品吧。</p>
    <a href="{{ url_for('main.index') }}" class="btn btn-primary">去逛逛</a>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 购物车数据由后端渲染到前端，便于首屏展示。
    let cartItems = {{ cart_items_json | tojson }};

    document.addEventListener("DOMContentLoaded", function () {
        renderCart();
    });

    function renderCart() {
        const container = document.getElementById("cartItemsContainer");
        const content = document.getElementById("cartContent");
        const empty = document.getElementById("emptyCart");

        if (!cartItems.length) {
            content.classList.add("d-none");
            empty.classList.remove("d-none");
            return;
        }

        content.classList.remove("d-none");
        empty.classList.add("d-none");
        container.innerHTML = "";

        cartItems.forEach(item => {
            const subtotal = item.quantity * item.goods.price;
            container.insertAdjacentHTML("beforeend", `
                <div class="row align-items-center border-bottom py-3" data-id="${item.id}">
                    <div class="col-1 text-center">
                        <input type="checkbox" class="cart-item-checkbox" ${item.selected ? "checked" : ""} onchange="toggleItem('${item.id}', this.checked)">
                    </div>
                    <div class="col-2">
                        <img src="${item.goods.mainimg}" alt="${item.goods.goodsname}" class="img-fluid rounded">
                    </div>
                    <div class="col-3">
                        <div class="fw-bold">${item.goods.goodsname}</div>
                        <div class="text-muted small">${item.goods.model || ""}</div>
                    </div>
                    <div class="col-2 text-center">¥${item.goods.price.toFixed(2)}</div>
                    <div class="col-2 text-center">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="updateQuantity('${item.id}', -1)">-</button>
                            <button class="btn btn-light" disabled>${item.quantity}</button>
                            <button class="btn btn-outline-secondary" onclick="updateQuantity('${item.id}', 1)">+</button>
                        </div>
                    </div>
                    <div class="col-1 text-center fw-bold">¥${subtotal.toFixed(2)}</div>
                    <div class="col-1 text-center">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem('${item.id}')"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `);
        });

        const allSelected = cartItems.length > 0 && cartItems.every(i => i.selected);
        document.getElementById("selectAllTop").checked = allSelected;
        updateSummary();
    }

    // 更新单个商品数量（调用后端增减接口）。
    function updateQuantity(itemId, change) {
        const item = cartItems.find(i => i.id == itemId);
        if (!item) return;
        if (change < 0 && item.quantity <= 1) return;

        const url = change > 0 ? "{{ url_for('order.add_to_cart') }}" : "{{ url_for('order.decrease_cart_item') }}";
        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify({ goods_id: item.goods.id, quantity: Math.abs(change) })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                item.quantity = data.quantity || (item.quantity + change);
                renderCart();
            } else {
                alert(data.message || "操作失败");
                if (data.redirect) window.location.href = data.redirect;
            }
        })
        .catch(() => alert("操作失败，请重试"));
    }

    function toggleItem(itemId, checked) {
        const item = cartItems.find(i => i.id == itemId);
        if (item) item.selected = checked;
        renderCart();
    }

    function removeItem(itemId) {
        if (!confirm("确定要删除该商品吗？")) return;
        fetch("{{ url_for('order.remove_cart_item') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify({ item_id: itemId })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                cartItems = cartItems.filter(i => i.id != itemId);
                renderCart();
                const badge = document.querySelector(".badge.bg-danger");
                if (badge && data.cart_count !== undefined) badge.textContent = data.cart_count;
            } else {
                alert(data.message || "删除失败");
            }
        })
        .catch(() => alert("操作失败，请重试"));
    }

    function toggleSelectAll(checkbox) {
        cartItems.forEach(i => i.selected = checkbox.checked);
        renderCart();
    }

    function batchRemove() {
        const selectedItems = cartItems.filter(i => i.selected);
        if (!selectedItems.length) {
            alert("请先选择要删除的商品");
            return;
        }
        if (!confirm(`确定删除选中的 ${selectedItems.length} 个商品吗？`)) return;

        fetch("{{ url_for('order.batch_remove_cart_items') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify({ item_ids: selectedItems.map(i => i.id) })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                cartItems = cartItems.filter(i => !i.selected);
                renderCart();
                const badge = document.querySelector(".badge.bg-danger");
                if (badge && data.cart_count !== undefined) badge.textContent = data.cart_count;
            } else {
                alert(data.message || "删除失败");
            }
        })
        .catch(() => alert("操作失败，请重试"));
    }

    function updateSummary() {
        let count = 0;
        let total = 0;
        cartItems.forEach(i => {
            if (i.selected) {
                count += i.quantity;
                total += i.quantity * i.goods.price;
            }
        });
        document.getElementById("summaryCount").textContent = count;
        document.getElementById("summaryTotal").textContent = `¥${total.toFixed(2)}`;
        document.getElementById("summaryFinal").textContent = `¥${total.toFixed(2)}`;
    }

    // 结算：先创建订单，再跳转到支付页。
    function proceedToCheckout() {
        const selectedItems = cartItems.filter(i => i.selected);
        if (!selectedItems.length) {
            alert("请至少选择一个商品");
            return;
        }

        const btn = document.querySelector(".btn.btn-primary.w-100");
        const old = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>正在创建订单...';

        fetch("{{ url_for('order.checkout_cart') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify({ item_ids: selectedItems.map(i => i.id) })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.href = "/order/check/" + data.order_id;
            } else {
                alert(data.message || "结算失败");
                btn.disabled = false;
                btn.innerHTML = old;
            }
        })
        .catch(() => {
            alert("系统错误，请重试");
            btn.disabled = false;
            btn.innerHTML = old;
        });
    }
</script>
{% endblock %}
