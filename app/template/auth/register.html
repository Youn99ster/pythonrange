{% extends "base.html" %}

{% block title %}用户注册 - HackShop{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 620px;">
    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <h2 class="h4 mb-3">用户注册</h2>
            <p class="text-muted">创建账号，开始使用 HackShop 靶场。</p>

            <div id="alert-container"></div>

            <form id="register-form" method="POST" action="{{ url_for('auth.register') }}">
                <div class="mb-3">
                    <label for="register-username" class="form-label">用户名</label>
                    <input type="text" id="register-username" name="username" class="form-control" required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="mb-3">
                    <label for="register-email" class="form-label">邮箱地址</label>
                    <input type="email" id="register-email" name="email" class="form-control" required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="mb-3">
                    <label for="register-email-code" class="form-label">邮件验证码</label>
                    <div class="row g-2 align-items-stretch">
                        <div class="col-8">
                            <input type="text" id="register-email-code" name="email_code" class="form-control" placeholder="输入邮件验证码" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-4">
                            <button type="button" id="send-email-code" class="btn btn-outline-primary w-100 h-100">发送验证码</button>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="register-password" class="form-label">密码</label>
                    <input type="password" id="register-password" name="password" class="form-control" required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="mb-3">
                    <label for="register-confirm" class="form-label">确认密码</label>
                    <input type="password" id="register-confirm" name="confirm_password" class="form-control" required>
                    <div class="invalid-feedback"></div>
                </div>

                <div class="form-check mb-3">
                    <input type="checkbox" id="agree-terms" name="agree_terms" class="form-check-input" required>
                    <label class="form-check-label" for="agree-terms">
                        我同意<a href="#" onclick="showAlert('服务条款暂未开放', 'info')">服务条款</a>和
                        <a href="#" onclick="showAlert('隐私政策暂未开放', 'info')">隐私政策</a>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary w-100">注册</button>
            </form>

            <div class="text-center mt-3">
                <a href="{{ url_for('auth.login') }}">已有账号？立即登录</a>
            </div>
            <div class="text-center mt-2">
                <a href="{{ url_for('main.index') }}">返回首页</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type = 'info') {
        document.getElementById('alert-container').innerHTML = `
            <div class="alert alert-${type}" role="alert">${message}</div>
        `;
    }

    function showFieldError(fieldId, message) {
        const input = document.getElementById(fieldId);
        if (!input) return;
        input.classList.add('is-invalid');
        const box = input.parentElement.querySelector('.invalid-feedback') || input.nextElementSibling;
        if (box) box.textContent = message;
    }

    function clearFieldError(fieldId) {
        const input = document.getElementById(fieldId);
        if (!input) return;
        input.classList.remove('is-invalid');
        const box = input.parentElement.querySelector('.invalid-feedback') || input.nextElementSibling;
        if (box) box.textContent = '';
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isValidUsername(username) {
        return username.length >= 3 && /^[a-zA-Z0-9_]+$/.test(username);
    }

    document.getElementById('register-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const username = document.getElementById('register-username').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        const confirm = document.getElementById('register-confirm').value;
        const emailCode = document.getElementById('register-email-code').value.trim();

        ['register-username','register-email','register-password','register-confirm','register-email-code'].forEach(clearFieldError);

        if (!isValidUsername(username)) {
            showFieldError('register-username', '用户名至少3个字符，只能包含字母、数字和下划线');
            return;
        }
        if (!isValidEmail(email)) {
            showFieldError('register-email', '请输入有效的邮箱地址');
            return;
        }
        if (!password) {
            showFieldError('register-password', '请输入密码');
            return;
        }
        if (password.length < 6) {
            showFieldError('register-password', '密码至少6个字符');
            return;
        }
        if (password !== confirm) {
            showFieldError('register-confirm', '两次输入的密码不一致');
            return;
        }
        if (!emailCode) {
            showFieldError('register-email-code', '请输入邮件验证码');
            return;
        }

        try {
            const resp = await fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    username,
                    email,
                    password,
                    confirm_password: confirm,
                    email_code: emailCode
                })
            });
            const body = await resp.json();
            if (resp.ok) {
                showAlert(body.message || '注册成功，正在跳转到登录页面...', 'success');
                setTimeout(() => window.location.href = "{{ url_for('auth.login') }}", 1200);
            } else {
                showAlert(body.message || '注册失败，请稍后重试', 'danger');
            }
        } catch (error) {
            console.error('请求异常:', error);
            showAlert('网络错误，请稍后重试', 'danger');
        }
    });

    document.getElementById('send-email-code').addEventListener('click', async function() {
        const email = document.getElementById('register-email').value.trim();
        if (!isValidEmail(email)) {
            showFieldError('register-email', '请先输入有效的邮箱地址');
            return;
        }
        clearFieldError('register-email');

        const btn = this;
        btn.disabled = true;
        btn.textContent = '发送中...';

        try {
            const resp = await fetch('/send_mail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ email })
            });
            const data = await resp.json();
            if (resp.ok) {
                showAlert(data.message || '验证码已发送，请注意查收', 'success');
            } else {
                showAlert(data.message || '验证码发送失败', 'danger');
            }
        } catch (error) {
            console.error('请求异常:', error);
            showAlert('网络错误，请稍后重试', 'danger');
        } finally {
            btn.disabled = false;
            btn.textContent = '发送验证码';
        }
    });
</script>
{% endblock %}
